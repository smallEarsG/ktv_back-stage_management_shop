# KTV用户端小程序产品需求文档 (PRD) & 技术架构

## 1. 产品概述

**产品名称**：KTV自助点单小程序
**核心价值**：为到店顾客提供“扫码-点单-支付”的闭环自助服务，减轻服务员人工点单压力，提升下单效率与准确率，并沉淀私域会员流量。
**关联系统**：数据与“KTV商户后台管理系统”完全打通，复用商品、订单、房间等核心数据。

## 2. 用户角色与流程

### 2.1 用户角色

* **普通顾客**：无需注册，扫码即可点单（游客模式）。

* **会员用户**：授权微信手机号登录，享受会员价、积分、储值消费。

### 2.2 核心业务流程

1. **进店/入包厢**：顾客进入包厢。
2. **扫码**：扫描桌上/墙上的二维码（对应商户后台生成的房间二维码）。
3. **绑定房间**：小程序自动识别并绑定当前 `store_id` 和 `room_id`。
4. **浏览点单**：查看酒水、零食、果盘套餐；加入购物车。
5. **支付下单**：确认订单 -> 调起微信支付 -> 支付成功。
6. **出品配送**：商户后台收到新订单提醒 -> 服务员接单 -> 配送到房。
7. **订单完成**：用户在小程序查看进度（待接单 -> 配送中 -> 已完成）。

```mermaid
graph LR
A[用户扫码] --> B{识别二维码}
B -->|无效码| C[提示错误]
B -->|有效码| D[进入点单页(绑定房间)]
D --> E[选购商品]
E --> F[购物车结算]
F --> G[微信支付]
G --> H[生成订单(状态:已支付)]
H --> I[商户后台自动接单/打印]
```

## 3. 功能模块设计

### 3.1 首页/点单页

* **顶部**：当前房间号显示（如：V01包厢），门店名称。

* **公告栏**：滚动播放门店促销信息。

* **侧边栏分类**：复用后台配置的“商品分类”（如：啤酒、洋酒、小吃、主食）。

* **商品列表**：

  * 展示商品图、名称、价格（原价/会员价）。

  * 标签：热销、推荐、新品。

  * **多规格选择**：(如：一打/半打，冰/常温) *需后台商品表支持规格扩展*。

  * 库存校验：实时读取后台库存，库存不足无法添加。

### 3.2 购物车

* **商品汇总**：按分类折叠或列表展示。

* **数量调整**：增减商品数量。

* **备注填写**：整单备注（如：多加冰、不需要开瓶）。

* **金额计算**：自动计算总价、优惠金额。

### 3.3 订单中心

* **当前订单**：显示当次消费的未完成订单。

  * 状态流转：已下单 -> 制作中 -> 配送中 -> 已完成。

  * **催单功能**：点击发送催单通知到商户后台（限制频率）。

* **历史订单**：查看过往消费记录。

### 3.4 个人中心

* **会员卡**：展示会员等级、余额、积分。

* **优惠券**：查看可用/已用优惠券。

* **呼叫服务**：快捷按钮（呼叫保洁、呼叫麦克风服务、呼叫结账）。

## 4. 接口与数据交互 (对接现有后端)

### 4.1 接口规划 (API Prefix: `/api/miniapp`)

| 模块     | 接口路径                     | 方法   | 描述                            |
| :----- | :----------------------- | :--- | :---------------------------- |
| **认证** | `/auth/login`            | POST | 微信 `jscode2session` 登录，返回 JWT |
| **门店** | `/store/info`            | GET  | 获取门店基础信息 (Logo, 电话, 公告)       |
| **商品** | `/products`              | GET  | 获取分类及商品列表 (仅上架商品)             |
| **商品** | `/products/{id}`         | GET  | 商品详情                          |
| **订单** | `/orders`                | POST | 创建订单 (需校验库存、房间状态)             |
| **订单** | `/orders`                | GET  | 获取我的订单列表                      |
| **订单** | `/orders/{id}`           | GET  | 订单详情                          |
| **支付** | `/payment/wechat/prepay` | POST | 获取微信支付预支付参数                   |
| **服务** | `/service/call`          | POST | 发起呼叫服务 (推送消息给后台)              |

### 4.2 数据模型调整建议

基于现有 `technical_architecture_ktv_backend.md`，建议补充：

1. **C端用户表 (`c_users`)**：与后台管理用户 (`users`) 区分。

   * 字段：`openid` (主键/索引), `nickname`, `avatar`, `phone`, `balance`, `points`, `created_at`, `updated_at`。

   * *说明*：用于存储小程序授权用户信息及会员权益。
2. **购物车策略**：

   * **纯前端缓存**：采用 Pinia + LocalStorage 进行本地持久化存储。

   * *优势*：减少后端交互压力，离线可用，用户体验更流畅。

   * *逻辑*：用户添加商品 -> 存入本地 Storage -> 下单时一次性提交商品清单 -> 后端校验库存并创建订单 -> 清空本地已提交的购物车项。
3. **商品表扩展**：建议增加 `specs` (规格JSON) 字段，支持多规格。

## 5. 技术架构建议

### 5.1 前端技术栈

* **框架**：**Uni-app** (Vue3版本)

  * *理由*：一套代码可发布为微信小程序，未来可扩展至支付宝/抖音小程序；Vue3语法与商户后台技术栈统一，降低开发维护成本。

* **UI库**：UView Plus 或 Uni-ui。

* **状态管理**：Pinia (存储购物车、用户信息)。

### 5.2 交互设计风格

* **暗黑模式**：考虑到KTV包厢光线较暗，小程序建议采用深色主题或暗黑模式，避免屏幕刺眼。

* **大触控区**：点歌/点单环境嘈杂且可能饮酒，按钮设计应足够大，操作路径尽量短。

### 5.3 部署架构

* **小程序端**：上传至微信公众平台。

* **API服务**：共用商户后台 Spring Boot 服务，通过 Security 配置不同的过滤器链处理 C 端请求。

